<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="../assets/image__2_-removebg-preview.png" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <link rel="stylesheet" href="../css/style.css">
  <title>Adamot</title>
</head>

<body>
  <header>
    <img style="width: 300px;" src="../assets/logo1.png" alt="">
  </header>

  <div class="main-container">
    <aside class="sidebar">

      <h3 class="ativo"><a href="dashboard.html">
          <img style="width: 20px;" src="../assets/painel.png" alt="dashemoji">
          Dashboard
        </a>
      </h3>

      <h3><a href="sensores.html">
          <img style="width: 20px;" src="../assets/sensor.png" alt="sensor">
          Sensores
        </a>
      </h3>

      <h3><a href="chamados.html">
          <img style="width: 20px;" src="../assets/atendimento-ao-cliente.png" alt="chamadoEmoji">
          Chamados
        </a>
      </h3>

      <h3><a href="relatorios.html">
          <img style="width: 20px;" src="../assets/relatorio.png" alt="sensorEmoji">
          Relatórios
        </a>
      </h3>


      <h4><a href="../index.html">
          <img style="width: 15px;" src="../assets/sair.png" alt="exit">
          Sair
        </a>
      </h4>
    </aside>

    <div class="content1">
      <div class="welcome-bar">Olá,
        <span id="b_usuario"></span>
      </div>

      <section class="kpis">
        <div class="card">
          <h3>Total de Visitantes</h3>
          <p id="totalVisitantes">3.000</p>

        </div>

        <div class="card">
          <h3>Pico de Fluxo</h3>
          <p id="picoFluxo">17h</p>
        </div>

        <div class="card">
          <h3>Média por Hora</h3>
          <p id="mediaHora">185</p>
        </div>
      </section>

      <div class="graphs-container">
        <div class="chart-container">
          <h2>Fluxo atual</h2>
          <canvas id="linechart"></canvas>
          <div>
            <span style="opacity: 0.5;">Horários</span>
          </div>
        </div>

        <div class="heatmap-container">
          <h2>Mapa de Calor</h2>

          <svg id="shoppingMap" viewBox="0 0 400 197" class="heatmap">
            <rect id="entrada1" x="20" y="30" width="80" height="80" rx="20">
              <title>0 Pessoas</title>
            </rect>
            <rect id="entrada2" x="150" y="30" width="80" height="80" rx="20">
              <title>0 Pessoas</title>
            </rect>
            <rect id="entrada3" x="280" y="30" width="80" height="80" rx="20">
              <title> 0 Pessoas</title>
            </rect>

            <text x="25" y="130" style="opacity: 0.5;">Entrada A</text>
            <text x="155" y="130" style="opacity: 0.5;">Entrada B</text>
            <text x="285" y="130" style="opacity: 0.5;">Entrada C</text>
          </svg>

          <div class="legend">
            <div class="legend-color" style="background-color: #e74c3c;"></div><span style="opacity: 0.5;">~100
              Pessoas</span>
            <div class="legend-color" style="background-color: #f1c40f;"></div><span style="opacity: 0.5;">~50
              Pessoas</span>
            <div class="legend-color" style="background-color: #2ecc71;"></div><span style="opacity: 0.5;">~10
              Pessoas</span>
          </div>
        </div>
      </div>

    </div>
  </div>

</body>
<script>
  var fkShopping = sessionStorage.ID_SHOPPING;
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  let proximaAtualizacao;

  obterDadosGrafico(fkShopping)
  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGrafico(fkShopping) {

    if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

    fetch(`/registros/ultimos/${fkShopping}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, fkShopping);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, fkShopping) {
      

    console.log('iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels
    let labels = [];
    let dataPessoas = [];

    for (let i = 0; i < resposta.length; i++) {
      labels.push(resposta[i].hora + ':00')
      dataPessoas.push(resposta[i].pessoas)
    }


    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [{
        label: 'Número de Pessoas',
        data: dataPessoas,
        borderWidth: 2,
        backgroundColor: "rgba(138,43,226,0.2)",
        borderColor: "violet",
        tension: 0.3,
        fill: true
      }]
    };


    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: dados,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`linechart`),
      config
    );

    setTimeout(() => atualizarGrafico(fkShopping, dados, myChart), 2000);
  }


  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas, 

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(fkShopping, dados, myChart) {



    fetch(`/registros/tempo-real/${fkShopping}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json()
          .then(function (novoRegistro) {

            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {

            } else {
              dados.labels.shift()
              dados.labels.push(novoRegistro[0].momento_grafico)

              dados.datasets[0].data.shift()
              dados.datasets[0].data.push(novoRegistro[0].pessoas)

              myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(fkShopping, dados, myChart), 2000);
          });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(fkShopping, dados, myChart), 10000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  const entrada = [
    { id: "entrada1", nome: "Entrada A", valor: 100 },
    { id: "entrada2", nome: "Entrada B", valor: 50 },
    { id: "entrada3", nome: "Entrada C", valor: 0 }
  ];

  const colorScale = d3.scaleLinear()
    .domain([0, 50, 100])
    .range(["#2ecc71", "#f1c40f", "#e74c3c"]);




  function atualizarMapa() {

    entrada.forEach(e => {
      d3.select(`#${e.id}`)
        .transition()
        .duration(800)
        .attr("fill", colorScale(e.valor))
        .select("title")
        .text(`${e.nome}: ${e.valor} Pessoas`)
    })
  }

  atualizarMapa()

</script>

</html>