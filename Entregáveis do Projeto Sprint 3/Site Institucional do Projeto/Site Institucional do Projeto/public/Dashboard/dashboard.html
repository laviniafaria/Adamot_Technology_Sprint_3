<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="../assets/image__2_-removebg-preview.png" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
  <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-heatmap.min.js"></script>
  <link rel="stylesheet" href="../css/style.css">
  <title>Adamot</title>
</head>

<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="../assets/image__2_-removebg-preview.png" alt="logoadamot">
      <h3 class="ativo"><a href="dashboard.html">
          <img style="width: 20px;" src="../assets/painel.png" alt="dashemoji">
          Dashboard
        </a>
      </h3>

      <h3><a href="sensores.html">
          <img style="width: 20px;" src="../assets/sensor.png" alt="sensor">
          Sensores
        </a>
      </h3>

      <h3><a href="chamados.html">
          <img style="width: 20px;" src="../assets/atendimento-ao-cliente.png" alt="chamadoEmoji">
          Chamados
        </a>
      </h3>

      <h3><a href="relatorios.html">
          <img style="width: 20px;" src="../assets/relatorio.png" alt="sensorEmoji">
          Relatórios
        </a>
      </h3>


      <h4><a href="../index.html">
          <img style="width: 15px;" src="../assets/sair.png" alt="exit">
          Sair
        </a>
      </h4>
    </aside>

    <div class="content1">
      <div class="welcome-bar">Olá,
        <span id="b_usuario"></span>
      </div>

      <section class="kpis">
        <div class="card">
          <h3>Total de Visitantes</h3>
          <p id="totalVisitantes"></p>

        </div>

        <div class="card">
          <h3>Pico de Fluxo</h3>
          <p id="picoVisitantes"></p>
        </div>

        <div class="card">
          <h3>Média do Fluxo por Hora</h3>
          <p id="mediaHora"></p>
        </div>
      </section>

      <div class="graphs-container">
        <div class="chart-container">
          <h2>Fluxo por Hora</h2>
          <canvas id="linechart"></canvas>
          <div>
            <span style="opacity: 0.5;">Horários</span>
          </div>
        </div>


        <div class="heatmap-container">
          <h2>Mapa de calor</h2>
          <div class="calorento" id="MapaA"></div>
        </div>

      </div>

    </div>
  </div>

</body>
<script>
  var fkShopping = sessionStorage.ID_SHOPPING;
  b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

  let proximaAtualizacao;

  obterDadosGrafico(fkShopping);

  function obterDadosGrafico(fkShopping) {

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/registros/ultimos/${fkShopping}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();

          plotarGrafico(resposta, fkShopping);

        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }

  fetch(`/registros/totalVisitantes/${fkShopping}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
      response.json().then(function (resposta1) {
        console.log(`Dados recebidos: ${JSON.stringify(resposta1)}`);
        kpiTotal(resposta1);

      });
    } else {
      console.error('Nenhum dado encontrado ou erro na API');
    }
  })
    .catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

  fetch(`/registros/picoVisitantes/${fkShopping}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
      response.json().then(function (resposta2) {
        console.log(`Dados recebidos: ${JSON.stringify(resposta2)}`);
        kpiPico(resposta2);

      });
    } else {
      console.error('Nenhum dado encontrado ou erro na API');
    }
  })
    .catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

  fetch(`/registros/mediaVisitantes/${fkShopping}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
      response.json().then(function (resposta3) {
        console.log(`Dados recebidos: ${JSON.stringify(resposta3)}`);
        kpiMedia(resposta3);

      });
    } else {
      console.error('Nenhum dado encontrado ou erro na API');
    }
  })
    .catch(function (error) {
      console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });


  function plotarGrafico(resposta, fkShopping) {

    console.log('iniciando plotagem do gráfico...');

    let labels = [];
    let dataPessoas = [];

    for (let i = 0; i < resposta.length; i++) {
      labels.push(resposta[i].hora)
      dataPessoas.push(resposta[i].pessoas)
    }

    let dados = {
      labels: labels,
      datasets: [{
        label: 'Número de Pessoas',
        data: dataPessoas,
        borderWidth: 2,
        backgroundColor: "rgba(138,43,226,0.2)",
        borderColor: "violet",
        tension: 0.3,
        fill: true
      }]
    };

    const config = {
      type: 'line',
      data: dados,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    };

    let myChart = new Chart(
      document.getElementById(`linechart`),
      config
    );

    setTimeout(() => atualizarGrafico(fkShopping, dados, myChart), 2000);
  }

  function atualizarGrafico(fkShopping, dados, myChart) {



    fetch(`/registros/tempo-real/${fkShopping}`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json()
          .then(function (novoRegistro) {

            let novaHora = novoRegistro[0].hora;

            if (novaHora !== dados.labels[dados.labels.length - 1]) {
              dados.labels.shift();
              dados.labels.push(novaHora);

              dados.datasets[0].data.shift();
              dados.datasets[0].data.push(novoRegistro[0].pessoas);

              myChart.update();
            }

            proximaAtualizacao = setTimeout(() => atualizarGrafico(fkShopping, dados, myChart), 2000);
          });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');

        proximaAtualizacao = setTimeout(() => atualizarGrafico(fkShopping, dados, myChart), 2000);
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }




  var seg_00 = 0;
  var ter_00 = 0;
  var qua_00 = 0;
  var qui_00 = 0;
  var sex_00 = 0;
  var sab_00 = 0;
  var dom_00 = 0;

  var seg_03 = 0;
  var ter_03 = 0;
  var qua_03 = 0;
  var qui_03 = 0;
  var sex_03 = 0;
  var sab_03 = 0;
  var dom_03 = 0;

  var seg_06 = 0;
  var ter_06 = 0;
  var qua_06 = 0;
  var qui_06 = 0;
  var sex_06 = 0;
  var sab_06 = 0;
  var dom_06 = 0;

  var seg_09 = 0;
  var ter_09 = 0;
  var qua_09 = 0;
  var qui_09 = 0;
  var sex_09 = 0;
  var sab_09 = 0;
  var dom_09 = 0;

  var seg_12 = 0;
  var ter_12 = 0;
  var qua_12 = 0;
  var qui_12 = 0;
  var sex_12 = 0;
  var sab_12 = 0;
  var dom_12 = 0;

  var seg_15 = 0;
  var ter_15 = 0;
  var qua_15 = 0;
  var qui_15 = 0;
  var sex_15 = 0;
  var sab_15 = 0;
  var dom_15 = 0;

  var seg_18 = 0;
  var ter_18 = 0;
  var qua_18 = 0;
  var qui_18 = 0;
  var sex_18 = 0;
  var sab_18 = 0;
  var dom_18 = 0;

  var seg_21 = 0;
  var ter_21 = 0;
  var qua_21 = 0;
  var qui_21 = 0;
  var sex_21 = 0;
  var sab_21 = 0;
  var dom_21 = 0;




  anychart.onDocumentReady(function () {

    var chart = anychart.heatMap(getDataA());

    var colorScale = anychart.scales.ordinalColor();
    colorScale.ranges([
      { less: 50, color: "#B0D8A4" },
      { from: 50, to: 100, color: "#FEE191" },
      { from: 100, to: 150, color: "#FD8060" },
      { from: 150, to: 200, color: "#F07355" },
      { greater: 200, color: "#CC333F" }
    ]);
    chart.colorScale(colorScale);

    chart
      .hovered()
      .fill(function () {
        return anychart.color.darken(this.sourceColor, 0.25);
      });
    chart.labels(false);

    chart.xAxis().stroke(null);
    chart.yAxis().stroke(null);
    chart.yAxis().labels().padding([0, 10, 0, 0]);
    chart.xAxis().labels().padding([0, 0, 10, 0]);

    chart.tooltip().title().useHtml(true);
    chart
      .tooltip()
      .useHtml(true)
      .titleFormat(function () {
        return "Pessoas - " + this.heat;
      })
      .format(function () {
        return (
          '<span style="color: #CECECE">Coordenada X </span>' +
          this.x +
          "<br/>" +
          '<span style="color: #CECECE">Coordenada Y </span>' +
          this.y
        );
      });

    chart
      .title()
      .enabled(false)
      .text("Mapa de Calor do Shopping Y")
      .padding([0, 0, 20, 0]);

    chart.container("MapaA");

    chart.draw();
  });

  function getDataA() {
    return [
      { x: "Seg", y: "00:00", heat: seg_00 },
      { x: "Ter", y: "00:00", heat: ter_00 },
      { x: "Qua", y: "00:00", heat: qua_00 },
      { x: "Qui", y: "00:00", heat: qui_00 },
      { x: "Sex", y: "00:00", heat: sex_00 },
      { x: "Sab", y: "00:00", heat: sab_00 },
      { x: "Dom", y: "00:00", heat: dom_00 },

      { x: "Seg", y: "03:00", heat: seg_03 },
      { x: "Ter", y: "03:00", heat: ter_03 },
      { x: "Qua", y: "03:00", heat: qua_03 },
      { x: "Qui", y: "03:00", heat: qui_03 },
      { x: "Sex", y: "03:00", heat: sex_03 },
      { x: "Sab", y: "03:00", heat: sab_03 },
      { x: "Dom", y: "03:00", heat: dom_03 },

      { x: "Seg", y: "06:00", heat: seg_06 },
      { x: "Ter", y: "06:00", heat: ter_06 },
      { x: "Qua", y: "06:00", heat: qua_06 },
      { x: "Qui", y: "06:00", heat: qui_06 },
      { x: "Sex", y: "06:00", heat: sex_06 },
      { x: "Sab", y: "06:00", heat: sab_06 },
      { x: "Dom", y: "06:00", heat: dom_06 },

      { x: "Seg", y: "09:00", heat: seg_09 },
      { x: "Ter", y: "09:00", heat: ter_09 },
      { x: "Qua", y: "09:00", heat: qua_09 },
      { x: "Qui", y: "09:00", heat: qui_09 },
      { x: "Sex", y: "09:00", heat: sex_09 },
      { x: "Sab", y: "09:00", heat: sab_09 },
      { x: "Dom", y: "09:00", heat: dom_09 },

      { x: "Seg", y: "12:00", heat: seg_12 },
      { x: "Ter", y: "12:00", heat: ter_12 },
      { x: "Qua", y: "12:00", heat: qua_12 },
      { x: "Qui", y: "12:00", heat: qui_12 },
      { x: "Sex", y: "12:00", heat: sex_12 },
      { x: "Sab", y: "12:00", heat: sab_12 },
      { x: "Dom", y: "12:00", heat: dom_12 },

      { x: "Seg", y: "15:00", heat: seg_15 },
      { x: "Ter", y: "15:00", heat: ter_15 },
      { x: "Qua", y: "15:00", heat: qua_15 },
      { x: "Qui", y: "15:00", heat: qui_15 },
      { x: "Sex", y: "15:00", heat: sex_15 },
      { x: "Sab", y: "15:00", heat: sab_15 },
      { x: "Dom", y: "15:00", heat: dom_15 },

      { x: "Seg", y: "18:00", heat: seg_18 },
      { x: "Ter", y: "18:00", heat: ter_18 },
      { x: "Qua", y: "18:00", heat: qua_18 },
      { x: "Qui", y: "18:00", heat: qui_18 },
      { x: "Sex", y: "18:00", heat: sex_18 },
      { x: "Sab", y: "18:00", heat: sab_18 },
      { x: "Dom", y: "18:00", heat: dom_18 },

      { x: "Seg", y: "21:00", heat: seg_21 },
      { x: "Ter", y: "21:00", heat: ter_21 },
      { x: "Qua", y: "21:00", heat: qua_21 },
      { x: "Qui", y: "21:00", heat: qui_21 },
      { x: "Sex", y: "21:00", heat: sex_21 },
      { x: "Sab", y: "21:00", heat: sab_21 },
      { x: "Dom", y: "21:00", heat: dom_21 },
    ];
  }












  function kpiTotal(resposta1) {
    let registro = resposta1[0].total;
    totalVisitantes.innerHTML = registro + ' pessoas';
    console.log(registro);
  }

  function kpiPico(resposta2) {
    let registro = resposta2[0].hora;
    picoVisitantes.innerHTML = registro + 'h';
    console.log(registro);
  }

  function kpiMedia(resposta3) {

    let registro = resposta3[0].media;
    mediaHora.innerHTML = registro + ' pessoas';
    console.log(resposta3)
  }

</script>

</html>